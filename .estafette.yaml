builder:
  track: dev

labels:
  type: service
  app-group: estafette-ci
  team: estafette
  language: golang

version:
  semver:
    major: 0
    minor: 1
    releaseBranch: main

triggers:
- pipeline:
    name: github.com/estafette/estafette-ci-db-migrator
    branch: master
  builds:
    branch: master

stages:
  build:
    image: golang:1.15.1-alpine3.12
    env:
      CGO_ENABLED: 0
      GOOS: linux
      GOGC: off
    commands:
    - go test -short ./...
    - go build -a -installsuffix cgo -ldflags "-X main.appgroup=${ESTAFETTE_LABEL_APP_GROUP} -X main.app=${ESTAFETTE_GIT_NAME} -X main.version=${ESTAFETTE_BUILD_VERSION} -X main.revision=${ESTAFETTE_GIT_REVISION} -X main.branch=${ESTAFETTE_GIT_BRANCH} -X main.buildDate=${ESTAFETTE_BUILD_DATETIME}" -o ./publish/${ESTAFETTE_GIT_NAME} .

  integration-tests-prepare:
    services:
    - name: cockroachdb
      multiStage: true
      image: cockroachdb/cockroach:v20.1.4
      shell: /bin/bash
      env:
        COCKROACH_SKIP_ENABLING_DIAGNOSTIC_REPORTING: "true"
      readiness:
        path: /health?ready=1
        port: 8080
        timeoutSeconds: 120
      commands:
      - /cockroach/cockroach start-single-node --insecure --advertise-addr cockroachdb

    image: estafette/estafette-ci-db-migrator:0.1
    env:
      COCKROACH_CONNECTION_STRING: postgresql://root@cockroachdb:26257/defaultdb?sslmode=disable
      ESTAFETTE_LOG_FORMAT: console

  integration-tests:
    image: golang:1.15.1-alpine3.12
    env:
      CGO_ENABLED: 0
      GOOS: linux
      GOGC: off
    commands:
    - go test -run TestIntegration ./...

  bake:
    image: extensions/docker:dev
    action: build
    inline: |
      FROM scratch

      LABEL maintainer="estafette.io" \
            description="The ${ESTAFETTE_GIT_NAME} is the component that handles api requests and starts build jobs using the estafette-ci-builder"

      COPY ca-certificates.crt /etc/ssl/certs/
      COPY ${ESTAFETTE_GIT_NAME} /

      ENV GRACEFUL_SHUTDOWN_DELAY_SECONDS="20"

      ENTRYPOINT ["/${ESTAFETTE_GIT_NAME}"]
    repositories:
    - estafette
    path: ./publish
    copy:
    - /etc/ssl/certs/ca-certificates.crt

  check-container:
    parallelStages:
      check-efficiency:
        image: extensions/docker:dev
        action: dive
        repositories:
        - estafette

      vulnerability-scan:
        image: extensions/docker:dev
        action: trivy
        repositories:
        - estafette

  push-to-docker-hub:
    image: extensions/docker:dev
    action: push
    repositories:
    - estafette

  slack-notify:
    image: extensions/slack-build-status:dev
    workspace: estafette
    channels:
    - '#build-status'
    when:
      status == 'succeeded' ||
      status == 'failed'

releases:
  tooling-estafette:
    actions:
    - name: deploy-canary
    - name: deploy-stable
    - name: rollback-canary
      hideBadge: true
    - name: restart-stable
      hideBadge: true
    clone: true
    stages:
      deploy:
        image: extensions/gke:dev
        namespace: estafette-ci
        visibility: iap
        iapOauthClientID: estafette.secret(8Nlk-Aq1sDFySTEg.EH4VgB8zQ_Uhimb_MdSPrVyJiOtqAop23D8zDjnksHbVJQ2Q_maGamkn6Kh0TAnD6a_oUpLNTUOUIuxFYmGy_74FqdOCvvvsB5_crRW4dFVWtLq7GRxy-cXzlJ5KjnUaKzXzCPlr17fqhJnBYVCLWQ==.OUMokSQrOO8DjQDtDOSJ_nWqk70cMMF42Q4-SBfJ33jfZiaK9obT5tkyEZmyyfFtVfSRrHo=)
        iapOauthClientSecret: estafette.secret(DtIinOnwxATamw47.3YE8gEmg5Bhrjpbm_oYIrSgY8HVUG97ecLjijXxiLhK7eVOkTe_hlJrEgxcgEplB.97AKjl7ynDZlpMnQ38BY_QIkxiEoO9WbdIjrilJSUQMz96JkMouDmp8CKXvS1TGvTrHJB10=)
        container:
          repository: estafette
          env:
            ESTAFETTE_LOG_FORMAT: v3
          cpu:
            request: 158m
            limit: 316m
          memory:
            request: 483Mi
            limit: 976Mi
          metrics:
            port: 9001
          lifecycle:
            prestopsleep: false
        sidecars:
        - type: openresty
          image: estafette/openresty-sidecar:1.15.8.2
          cpu:
            request: 43m
            limit: 85m
          memory:
            request: 34Mi
            limit: 68Mi
        - type: git-sync
          image: k8s.gcr.io/git-sync:v3.1.5
          env:
          - name: GIT_KNOWN_HOSTS
            value: "false"
          - name: GIT_SYNC_MAX_SYNC_FAILURES
            value: "10"
          - name: GIT_SYNC_WAIT
            value: "60"
          - name: GIT_SYNC_ROOT
            value: "/git-sync-root"
          args:
          - "-ssh"
          - estafette.secret(qy7o7SKbzOL1NSTf.nFNX_QO2JiVO-WzIq2ory58Fu7rcFA5Q6PiAMZ5j2WA2csTFe-DDdFVe-_EauA4ocGdHGZO0R8-08rCbb7UdOq8c5lQ1jxIK.2RdR8Aa7NSFI4APPsWoo2JkaqqvdHg9Ds-aMM4t0gCw6LNHUdJTEW4oO47nVON4JHmFYhlY=)
          - "-dest=/configs"
          - "-branch=master"
          - "-depth=1"
          securityContext:
            runAsUser: 65534 # git-sync user
          volumeMounts:
          - name: app-configs
            mountPath: /configs
          secrets:
            keys:
              git-sync-rsa: estafette.secret(iW83SZLoy02V1_PI.InzYlyzlwvpi6GCL-SrgGLeD6MdjotjtIZYSpL09BStzsJUiLmKbPlcC1Za_pXLQBGPhNr8GuSY_mk8W0t2c0g0EcuY9jc9oQ5ZDIDe6p_P-mycyOSX4Pf4vzcI2p31nqp7beUpGKVR7-fN0AtjkR8Ul4bfZ6USkqO2kM4xL92W-DKUOJ63XwXR6Sj5iANtRJ8Q8AEQGLcNMCy3Sna4ysN72TJ4_gTXYV4cjSWh0grhjLyDTySvb975ZbXdJs1EMUSypZIrAMpMxaJWgzLF7qc-8PZNPVZl_qg9lshRUYieypysdb-PzgVcWXssYd1brJ7RH5nLrzyQgi1vjfe5MhThUCzMQOEV0Qk_PLjPt-n-xVgXAn7gr0TWAaL0Lnh7pcClDgsDCOvF0k1ImDyYPFEd3-WmEZ5upFEzBt3XPpMX8cKWEroojYBPMNHq87WeoKqFyPkynJCv8JRh4OCKnUjpdgDjSrk46D1K8HcMwQY1MY-w40tR3PiJL5SbQ5qqwrsdtNkEh5R6YWXHaGo3s_tWZvvSCM8dhfPhpT7yjfG1v1e9q570tkP2MTQ6gyOzWd3VcJK9f-kBLhWTkaz2cSDGBk_Ezs-qp_BhGoW5OT8h_J9EC0L_yTa1O0YEk9cRpaaqClvluWbvskKUlMXnb4yL6w_-PeWMDnsDUxX74sWC0w7m6ewEK2fRmhteMWKdyTx5jnk2qxf0y4Ai3-lqpVq3cDkqfaIdMVoAU5VUsBbqHviB68HdXjsu_2Gg-4HzFHuzGfgCXaww5YBd3ACJLAL2sJ1Gb3Y4kI1HqYC9vY-oC50lFadGxD3kSlgUvK205hnGUhGPx3-FUVAZB7CLYNqlaH2m1HWExx9oNSyU9shpik3xRS5-D2AV3a6uWiPvEyy9lRdY0kOPTOcCTpLhGV1PeUuwaQ8q4u_Vg-KWhdo18jHqlqQPWEPzYuZoE42ko-dYh-eUNVvh-jJvb2lA1RHhr19DjW2BwuJAX-Fp9gZwcf-yFIwdiolwZh5JG20TmaB2drAdtcSpkI6PZsfBmJL-werE50yhJU25oNgqF7hfL0qnkRGEw-BPQPJaNceMKeTdphJl0535KBUWcxaxklM0_8o-EoW0uRdkfPKb32PqVeAl_ShJYUDumVgKFXzdjRWEFOUbe5-n_IH0n6TbLa_ad86wz5kKQoPftS06LNszZMS3lBNrXcEfrOlButnwxwLmy0N05mqUA4WPSJl9dQoY2pddXQL2KtdJYq1SjZtG7uD1euXvJhANJy7ts9V3uGR5zeYb-Yo1l_aMhmnLl8gMCWQg5ZaF0gLttJf9zyHb-_2uYmrbbPCLc8eSanZzx5qDOJSrQbf3lYRvHkmpWa0IyJD8iF6FYcwV5rhu5UaZvicGkBGO3JIb6UZC7tCH05_rOd39bBH631FUl-FM0gtNZJ-SE6Yqc7Qmd1BHk1cLYkAg-b4qOxWe_S4KIJQyBYaNiodrFXUJKBn8cuDRANQxGNUDtoq41FAyHEuXGvsw3QQ9KFkn-UTNs88znthPWphrdJrceZgsHFROGU8PSGCSDhX7sCMD76lm5R0SknZ4jhi2t-o7htok8k4i67HLa5gE77WbHTLYkgAuD5GVVDW-mmA0dqkyiSaCfyRbUhaIbW-fThLrSPYRaiMfNShdfR_X59DFFmS3rVKqgVzoj_E5_qwTpI55YcUU37SM8sKbwcoOgwUIJe6AB0h2R8JmZ0JVDgag2BjEH4gdp5Sr1Fe01R-f6VG4pM_roKsl7rxdphT3asgO2XsxsI4-nqmN8FJsdUIOv37Y2I2y9AKa8WIRpuRl7a4e3cKsC6MDu4yJ0FFyko3cCaTgVD7SNpTA_7c0Oki7j9dfCuumVBKtcEm1eX3MBj8SrHpVqtyQWBjU7FMwKNMTfAt3aWl_dyyPFnfrcwKVlh4OeIkeAGvabgeQIyek-uAexQZwhc9sQieuE8kpbP5tz3jUp3_tMAGbstQLTXCFQS--sHi-GodFch7IcKNfFclWW1ysAow3PscpkJV4UybFasDAlP8LTTEOBV45ekZUBdPtpxgFPQanHwXXLHsf1Woi5EqYwUR_AmNRlkN3n1VqfdtAvlOleyTQAHxsvweg4eNYgZ8ow9fF4Mi-x1nn6Sjs57BE7G8wBNPa1gNaIEFkc8e-EyaIz3WiabWoPTvkagvM3Jh5GTWjOgGWKC7uK38tPJJo8MBQS3JYzsIL998CKBJs_KBgR_yGKYpP6azIc6OO5cU6d8uN2e7Z0Pqc7tM4LW1NtEujRxOOr38TXwSKNg1uuJbIYkp3IwjDxr4qn9bIcT9zYtNPXEQzy8dOZjWR6sWnTuklSEimli8Ti7KbpGxSCMB9VHhPj-19mgZkmTX3Q6aUKevNdxDmo9GG6ZfQaZpCUDuWPFgbI14ntJzVdINJ-E5sgIj2eibS4KvrgUL9F9Asfzj0ErI7WL7BgLib1YiVa7-kw42yewswjUGllg4dvYduTgmecHPqY74zQheBa6nqyg83iJ-An2IoWo3goMm0-U74A9UlQK-BHUYswtBnPEj0n6Zr6NL6Ew7eYAizSQjjEpt4TGjRF-yodEizWkeYXOy3GrZIVW71SnEWMvx9Bk5jTmeuVfP2wGZwA5bzlaEPIw4n-HMJpvUmNj3l2231k4blahPvW5yR-h85SDUHuyueSP-cZfCDuzsEf-6lcyHJ_Nro5SYFwpyXa27-ubxj_OXNBN0AVfaVDbNj1RLA_9oBjX75L5lHwjNJHEm-jFsnQATgiOAOZe61xrOxoBSQruYnSXQhFOm85hl9JS7KHRPCOfsX_zcLtcLdJOkUwi8Oy2zdfWHJOK4PP4VK1z7Yp9XvNWFhL5SkC0GifyGQvCGm4jkRBVN0eo040TcKD2UsZaRyOlYFCK9IJbz9qmZ64wh1LVElAhptcZqOKconYjak3n0q0rB48sr43hjhmx4gJbcICJj7q6HTB1zSQ5PT1_s2aQ8sptQcxuXSHYQsGmi_Q2Ahd0yoJR6zUFs8zPWZLu9lbqh_lhUEtXipDfxmWswdPBhPuIOeGlwuwny8Nfr7qe_gTmFZRCyGBIMHNjevE8uLU-IHUr4Boeayrc_YVHyX2LTLrMNiQbbr3UXJSPHjMnvK7Noo1tVrNqiWX2nRlN9oqJAyFw5_nVDeHIZC2SW7TnpUAfFHVgRdS1iyaBeHGu8zvcWfPbhiF-jFRQNlWQSsKjHjkS15FxYhnwGypHuuAS__HUOA8TcxAGzhiXGewcOtES1OccpOPmP5TsiVYcUTMWQkcXB8KQiiAZjxw7wlkcIUlbpD_RwTKz5vQz9UzL5O6-nwYWJfgGrLeZ7yAbBjRe_1K9SGaMxJ1kFCohe45sqerlWZwQJgbVgYQn-mF3qMCYH1CPEN_gkYk0AyhBW1PRAvrXhRddk3kiJpLEgszVGcx3RKqQc0aTjWWegudodt2rReEGljoKDFEsj8xiXmwkO--AGO-MOjYmWzifRH5-5fS2R2w6IRba3pi2ROj.aDiB0nTFqd5Ey2-h2hvPLYG_vPIejv3YFLVXm4wBBWU3sNlYJaEicLTRfWejmM_bfLkBPSg=)
            mountpath: /etc/git-secret
        request:
          timeout: 120s
          maxbodysize: 128M
          clientbodybuffersize: 1m
          proxybuffersnumber: 64
        hosts:
        - estafette.secret(IIZF7TwhQlDeDqtY.s9R8iMp30_frYZoLU7dD1pbdvUg3SCELN3JAXBQ5YrwytnVz.sc58gdlwieDhIsEcQbVLyN3KpkBcjX4b30GYjooRz8zQaXWZFrGeEPJz9SHkSsK7YYOq3ms=)
        - estafette.secret(Ht4w97zYNegDUn90.dQLWAThFkF4B0GoNQVhFXjx8JvWE53Xicu6t00LcQTu83Kt8OBsR.dxjWCCtCykkLkCYBHFhWWS9hKr7I7WtdamC2R0kOioMqTdAQIZ5gtRV0YovWm3wjjqrcP3Y=)
        internalhosts:
        - estafette.secret(P6NY3iwsirEbkO1Z.RETF5WQACjanX8v4AUMWdQyC0IKfltnOj4mX9_yHvKUyOl5dDdLkHJIuIgdR5FAipt0OZQ==.Rl7F7HcHUCGtHJDyHVsefQ7YzYnEltjUj4Pc9_qD568jOVZCR8d5G436StjCQQRcntXGxdo=)
        - estafette.secret(Ms16kDpJJsAW2ttz.5PDwuKRZ8U6NztE7E7iBA3d46dHZoekuYWUXHvtqVsvhjIgmkSZ8tUoWxQJHAD8gv4je5E07dg==.5urwsbdeq1mHjp03TriPCn5l89PYrfQuZXEcC-MhD9rp14Au1heNbzww3acBPVN5rAF9dE0=)
        basepath: /api
        chaosproof: true
        useGoogleCloudCredentials: true
        disableServiceAccountKeyRotation: false
        manifests:
          files:
          - gke/ingress.yaml
          - gke/ingress-github.yaml
          - gke/ingress-bitbucket.yaml
          - gke/ingress-slack.yaml
          - gke/ingress-pubsub.yaml
          - gke/ingress-cloudsource.yaml
          - gke/integrations-certificate-secret.yaml
          data:
            IntegrationsHostname: estafette.secret(TLft87lv4YqRTpEk.RTcbrb0mtJ-y3FK49JErE9kLnhi-mruC2kZPwVQdE4MJqn4UOVqr5TnuIf6G4ftZdw==.Ry0bpK4h7oi4nBSz84AtB90LgxL_jOaCyUFc3FhWXY8NesulkHtkMSQOIPQ6M5ZSbe_CcUE=)
            IntegrationsHostname2: estafette.secret(TPjFkETu4Dig2jmS.IW-QvFT96oSyqX5XZHzO2cOtwao1SxwY8WDgHBDuN6iWnXyyYez1I3mmdWiaKHxVdM_6Lw==.I3WQtUf6sJO46TJbOmHBy8O-x65uRwAC4yjxGgX9c7PR03KvYjQidC4lj_f4brZV509_Uo8=)
        volumemounts:
        - name: client-certs
          mountpath: /cockroach-certs
          volume:
            secret:
              secretName: estafette-ci.client.api
              defaultMode: 0400
        - name: app-secrets
          mountpath: /secrets
          volume:
            secret:
              secretName: estafette-ci-config-secrets
        - name: app-configs
          mountpath: /configs
          volume: 
            emptyDir: {}
        - name: app-templates
          mountpath: /templates
          volume:
            configMap:
              name: estafette-ci-manifest-templates-configs

      slack-notify:
        image: extensions/slack-build-status:dev
        workspace: estafette
        channels:
        - '#release-status'
        when:
          status == 'succeeded' ||
          status == 'failed'